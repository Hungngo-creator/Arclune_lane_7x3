<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tap-to-Fly ‚Äî Slime & Classes v14</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f172a">
  <style>
    :root { color-scheme: dark light; }
    html,body{margin:0;padding:0;background:#0f172a;color:#fff;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{min-height:100vh;display:grid;place-items:center;padding:16px}
    .card{width:100%;max-width:900px;aspect-ratio:16/9;border-radius:18px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.4);position:relative;border:1px solid rgba(255,255,255,.08)}
    canvas{display:block;width:100%;height:100%;background:#0b1020;touch-action:manipulation}

    .hud{position:absolute;inset:0;pointer-events:none;display:flex;align-items:flex-start;justify-content:space-between;padding:10px}
    .pill{background:rgba(255,255,255,.12);backdrop-filter:blur(8px);padding:6px 10px;border-radius:14px;font-size:12px}

    .toolbar{position:absolute;left:12px;bottom:44px;display:flex;gap:8px;flex-wrap:wrap;pointer-events:auto;z-index:20}
    .btn{padding:6px 10px;border-radius:12px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.18);color:#fff;font-size:12px}
    .btn.active{background:rgba(14,165,233,.85);border-color:rgba(255,255,255,.35)}
    .btn.locked{opacity:.45;filter:grayscale(60%);border-style:dashed}
    .btn.locked::after{content:" üîí";font-size:12px;opacity:.85}
    .btn.skin{display:flex;align-items:center;gap:6px}
    .dot{width:12px;height:12px;border-radius:999px;border:1px solid rgba(255,255,255,.6)}
    .note{position:absolute;left:12px;bottom:10px;color:#ffffffb3;font-size:12px}

    .iconBtn{width:36px;height:28px;display:inline-grid;place-items:center}

    .micMeter{position:absolute;right:12px;bottom:12px;width:96px;height:8px;border-radius:999px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);pointer-events:none}
    .micMeter .fill{height:100%;width:0%;border-radius:inherit;background:#22d3ee}

    .overlay{position:absolute;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(6px);display:none;align-items:center;justify-content:center;z-index:30}
    .panel{width:min(560px,90%);max-height:80%;overflow:auto;background:rgba(15,23,42,.96);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:16px;box-shadow:0 20px 60px rgba(0,0,0,.5)}
    .row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px dashed rgba(255,255,255,.12)}
    .row:last-child{border-bottom:0}
    .price{opacity:.85}
    .title{font-weight:600}
    .actions{display:flex;gap:8px}

    .glow{animation:glow 1.2s ease-in-out infinite alternate}
    @keyframes glow{from{box-shadow:0 0 0 rgba(250,204,21,0)}to{box-shadow:0 0 22px rgba(250,204,21,.65);transform:translateY(-1px)}}

    .cdRing{position:absolute;bottom:44px;left:calc(12px + 44px + 8px);width:28px;height:28px;border-radius:50%;border:2px solid rgba(255,255,255,.25);display:grid;place-items:center;pointer-events:none}
    .cdRing span{font-size:11px;opacity:.9}

    /* Big skill button on the left */
    .skillBig{
      position:absolute; left:10px; top:50%; transform:translateY(-50%);
      width:96px; height:96px; border-radius:999px; z-index:25;
      display:grid; place-items:center; font-size:40px; line-height:1;
      background:rgba(14,165,233,.22); border:2px solid rgba(255,255,255,.25);
      box-shadow:0 10px 30px rgba(0,0,0,.45);
    }
    .skillBig.disabled{ opacity:.5; filter:grayscale(.2) }
    .skillBig span{ pointer-events:none }
    @media (max-width:420px){
      .skillBig{ width:84px; height:84px; font-size:36px; left:8px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <canvas id="game"></canvas>

      <div class="hud">
        <div class="pill">Space/‚Üë ho·∫∑c ch·∫°m = bay ‚Ä¢ P = pause ‚Ä¢ ‚ö° = kƒ© nƒÉng ‚Ä¢ üéôÔ∏è = la ƒë·ªÉ bay</div>
        <div class="pill">R = ch∆°i l·∫°i</div>
      </div>

      <div class="toolbar" id="toolbar">
        <button class="btn diff" data-diff="easy">Easy</button>
        <button class="btn diff" data-diff="normal">Normal</button>
        <button class="btn diff" data-diff="hard">Hard</button>

        <button class="btn iconBtn" id="pauseBtn" title="T·∫°m d·ª´ng">‚è∏Ô∏è</button>
        <button class="btn iconBtn" id="soundBtn" title="√Çm">üîä</button>
        <button class="btn iconBtn" id="voiceBtn" title="La ƒë·ªÉ bay">üéôÔ∏è</button>
        <button class="btn iconBtn" id="skillBtn" title="Kƒ© nƒÉng">‚ö°</button>

        <button class="btn" id="classBtn">Class: Aqua</button>

        <button class="btn skin" data-skin="gold"><span class="dot" style="background:#facc15"></span>Gold</button>
        <button class="btn skin" data-skin="pink"><span class="dot" style="background:#fb7185"></span>Pink</button>
        <button class="btn skin" data-skin="cyan"><span class="dot" style="background:#22d3ee"></span>Cyan</button>
        <button class="btn skin" data-skin="neon"><span class="dot" style="background:#a78bfa"></span>Neon</button>

        <button class="btn" id="shopBtn">Shop</button>
        <div class="btn" id="coinsPill">Feathers: 0</div>
      </div>

      <div class="cdRing" id="cdRing" aria-hidden="true"><span></span></div>
      <button id="skillBig" class="skillBig" title="Kƒ© nƒÉng"><span id="skillBigLabel">‚ö°</span></button>
      <div class="micMeter" id="micMeter" aria-hidden="true"><div class="fill" id="micFill"></div></div>
      <div class="note">Slime + Classes (Aqua/Jet) ‚Ä¢ Daily + Mic + Shield/Magnet + Pulse pipes.</div>

      <!-- Shop -->
      <div class="overlay" id="shop">
        <div class="panel">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div style="font-weight:700">Shop</div>
            <button class="btn" id="closeShop">ƒê√≥ng</button>
          </div>
          <div id="shopList"></div>
        </div>
      </div>

      <!-- Classes -->
      <div class="overlay" id="classes">
        <div class="panel">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div style="font-weight:700">Classes</div>
            <button class="btn" id="closeClasses">ƒê√≥ng</button>
          </div>
          <div id="classInfo" class="price" style="margin-bottom:8px"></div>
          <div id="classList"></div>
        </div>
      </div>

    </div>
  </div>
<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
let dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
function fit(){ dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
  const w=Math.min(window.innerWidth-32,900); const h=Math.floor(w*9/16);
  canvas.style.width=w+'px'; canvas.style.height=h+'px';
  canvas.width=Math.floor(w*dpr); canvas.height=Math.floor(h*dpr);
}
addEventListener('resize', fit); fit();

// Palettes
const SKINS={
  gold:{player:'#facc15',pipe:'#22c55e',edge:'rgba(0,0,0,.15)',skyTop:'#0ea5e9',skyBot:'#0b1020',ground:'rgba(255,255,255,.08)'},
  pink:{player:'#fb7185',pipe:'#34d399',edge:'rgba(0,0,0,.15)',skyTop:'#ec4899',skyBot:'#312e81',ground:'rgba(255,255,255,.10)'},
  cyan:{player:'#22d3ee',pipe:'#10b981',edge:'rgba(0,0,0,.15)',skyTop:'#06b6d4',skyBot:'#0b1020',ground:'rgba(255,255,255,.08)'},
  neon:{player:'#a78bfa',pipe:'#22d3ee',edge:'rgba(0,0,0,.18)',skyTop:'#1f2937',skyBot:'#0b1020',ground:'rgba(255,255,255,.10)'}
};

// Difficulty
const DIFFS={
  easy:  {speed:200, gravity:750,  jumpV:-240, spawnEvery:1650, spawnMin: 1050, gapBase:200, gapMin:188, scoreSpawnFactor:6,  scoreGapFactor:1.3},
  normal:{speed:220, gravity:850,  jumpV:-280, spawnEvery:1550, spawnMin: 950, gapBase:180, gapMin:166, scoreSpawnFactor:8,  scoreGapFactor:1.5},
  hard:  {speed:240, gravity:950, jumpV:-320, spawnEvery:1450, spawnMin: 850, gapBase:160, gapMin:144, scoreSpawnFactor:10, scoreGapFactor:1.8}
};

// Storage
const CURRENCY_NAME='Feathers';
let coins=+(localStorage.getItem('tapfly.coins')||0);
let owned=JSON.parse(localStorage.getItem('tapfly.owned')||'{}');
let inv  = JSON.parse(localStorage.getItem('tapfly.inv')  || '{"shield":0,"magnet":0}');
let next = JSON.parse(localStorage.getItem('tapfly.next') || '{"shield":false,"magnet":false}');
let diff=localStorage.getItem('tapfly.diff')||'easy';
let skin=localStorage.getItem('tapfly.skin')||'gold';

// Classes
let classesOwned=JSON.parse(localStorage.getItem('tapfly.classes')||'{"aqua":true}');
let classId=localStorage.getItem('tapfly.class')||'aqua';
let classUnlocked=localStorage.getItem('tapfly.classesUnlocked')==='1';
let classCore=+(localStorage.getItem('tapfly.classCore')||0);

function save(k,v){ localStorage.setItem(k, typeof v==='string'?v:JSON.stringify(v)); }
function saveCoins(){ save('tapfly.coins', coins); updateCoinsPill(); updateShopGlow(); }
function saveOwned(){ save('tapfly.owned', owned); }
function saveInv(){ save('tapfly.inv', inv); }
function saveNext(){ save('tapfly.next', next); }
function saveClasses(){ save('tapfly.classes', classesOwned); save('tapfly.class', classId); }

// Shop
const shop=document.getElementById('shop'); const shopBtn=document.getElementById('shopBtn'); const closeShop=document.getElementById('closeShop');
const SHOP=[
  {id:'skin.pink',   type:'skin',   label:'Skin: Pink',   price:120, apply:()=>{skin='pink';  applySkin();}},
  {id:'skin.cyan',   type:'skin',   label:'Skin: Cyan',   price:120, apply:()=>{skin='cyan';  applySkin();}},
  {id:'skin.neon',   type:'skin',   label:'Skin: Neon',   price:150, apply:()=>{skin='neon';  applySkin();}},
  {id:'cons.shield', type:'consum', label:'Shield x1',    price:25,  onBuy:()=>{inv.shield++; saveInv();}},
  {id:'cons.magnet', type:'consum', label:'Magnet 6s',    price:20,  onBuy:()=>{inv.magnet++; saveInv();}},
  {id:'trail.spark', type:'trail',  label:'Trail: Spark', price:120, apply:()=>{trailEnabled=true;}}
];
function cheapestNeeded(){ let best=Infinity; for(const it of SHOP){ if((it.type==='skin'||it.type==='trail') && !owned[it.id]) best=Math.min(best,it.price); } return best; }
function updateShopGlow(){ const need=cheapestNeeded(); if(!isFinite(need)) { shopBtn?.classList.remove('glow'); return; } if(coins>=need) shopBtn?.classList.add('glow'); else shopBtn?.classList.remove('glow'); }

shopBtn?.addEventListener('click', ()=>{ renderShop(); shop.style.display='flex'; sfxTick(); });
closeShop?.addEventListener('click', ()=>{ shop.style.display='none'; sfxTick(); });

function renderShop(){
  const list=document.getElementById('shopList'); list.innerHTML='';
  SHOP.forEach(item=>{
    const ownedFlag = (item.type==='skin'||item.type==='trail') ? !!owned[item.id] : false;
    const row=document.createElement('div'); row.className='row';
    let sub = `${CURRENCY_NAME}: ${item.price}`;
    if(item.type==='consum') sub += ` ‚Ä¢ T·ªìn: ${item.id==='cons.shield'?inv.shield:inv.magnet}`;
    const left=document.createElement('div'); left.innerHTML=`<div class="title">${item.label}</div><div class="price">${sub}</div>`;
    const actions=document.createElement('div'); actions.className='actions';
    const buy=document.createElement('button'); buy.className='btn';
    buy.textContent = (item.type==='consum') ? 'Mua x1' : (ownedFlag?'ƒê√£ mua':'Mua');
    buy.disabled = (item.type==='consum') ? (coins < item.price) : (ownedFlag || coins < item.price);
    buy.addEventListener('click', ()=>{
      if(coins < item.price) return;
      coins -= item.price; saveCoins();
      if(item.type==='consum'){ item.onBuy(); toast('ƒê√£ mua: '+item.label); }
      else { owned[item.id]=true; saveOwned(); item.apply?.(); updateSkinButtons(); toast('ƒê√£ mua: '+item.label); }
      renderShop(); sfxScore();
    });
    actions.appendChild(buy);

    if(item.type==='skin'){
      const equip=document.createElement('button'); equip.className='btn'; equip.textContent='Trang b·ªã'; equip.disabled=!ownedFlag;
      equip.addEventListener('click', ()=>{ item.apply(); saveOwned(); renderShop(); toast('Skin ƒë√£ trang b·ªã'); });
      actions.appendChild(equip);
    }
    if(item.type==='trail'){
      const toggle=document.createElement('button'); toggle.className='btn'; toggle.textContent='B·∫≠t trail'; toggle.disabled=!ownedFlag;
      toggle.addEventListener('click', ()=>{ item.apply(); saveOwned(); renderShop(); toast('Trail ON'); });
      actions.appendChild(toggle);
    }
    if(item.type==='consum'){
      const id = item.id==='cons.shield' ? 'shield' : 'magnet';
      const btnNext=document.createElement('button'); btnNext.className='btn';
      btnNext.textContent = (next[id]?'B·ªè trang b·ªã':'Trang b·ªã v√°n sau');
      btnNext.disabled = (id==='shield'?inv.shield:inv.magnet) <= 0 && !next[id];
      btnNext.addEventListener('click', ()=>{ next[id] = !next[id]; saveNext(); renderShop(); toast((next[id]?'S·∫Ω d√πng: ':'B·ªè d√πng: ')+item.label); });
      actions.appendChild(btnNext);
    }
    row.appendChild(left); row.appendChild(actions); list.appendChild(row);
  });
  updateCoinsPill(); updateShopGlow();
}

// Classes registry
const CLASSES = {
  aqua: {
    name:'Aqua', color:'#22d3ee', price:0,
    desc:'R∆°i m·ªÅm (‚àí6% gravity). ‚ö° Jet: b∆°m l·ª±c bay m·∫°nh. CD 5s.',
    cd:3500,
    passiveInit(){ gravityMul = 0.85; },
    canUse(){ return performance.now() >= skillReadyAt; },
    use(){
      if(!this.canUse() || state.status!=='playing') return;
      player.vy = jumpV * 1.4;  // Jet
      skillReadyAt = performance.now() + this.cd;
      sfxFlap(); toast('JET!'); navigator.vibrate?.(18);
    }
  },
  phase:{name:'Phase', color:'#a78bfa', price:150, desc:'(S·∫Øp c√≥) Ghost 0.8s, CD 11s.'},
  tempo:{name:'Tempo', color:'#60a5fa', price:150, desc:'(S·∫Øp c√≥) Slow 35% 2s, CD 12s.'},
  gauss:{name:'Gauss', color:'#06b6d4', price:150, desc:'(S·∫Øp c√≥) Magnet Pulse, CD 12s.'}
};

// Daily
const DAILY_REWARD = 30;
const today = new Date().toDateString(); const lastDay = localStorage.getItem('tapfly.day');
if (lastDay !== today){ coins += 20; localStorage.setItem('tapfly.day', today); saveCoins(); toast('+20 daily'); }
function seededGoal(dateStr){ let h=0; for(let i=0;i<dateStr.length;i++){ h=(h*31 + dateStr.charCodeAt(i))>>>0; } return 12 + (h % 11); }
const dayKey = new Date().toISOString().slice(0,10);
let daily = JSON.parse(localStorage.getItem('tapfly.daily')||'{}');
if(daily.date !== dayKey){ daily = {date:dayKey, goal: seededGoal(dayKey), done:false}; localStorage.setItem('tapfly.daily', JSON.stringify(daily)); }
function completeDaily(){ if(!daily.done){ daily.done=true; localStorage.setItem('tapfly.daily', JSON.stringify(daily));
  coins += DAILY_REWARD; saveCoins(); toast(`Daily +${DAILY_REWARD}F`); navigator.vibrate?.([60,60,60]); } }

// State
const state={status:'menu',score:0,best:+(localStorage.getItem('tapfly.best')||0)};
const player={x:120,y:(canvas.height/dpr)*0.5,vy:0,size:22};
const pipes=[], pickups=[], trail=[]; let trailEnabled=!!owned['trail.spark'];
let speed,gravity,jumpV,spawnMs=0;
let shield=0, shieldGrace=0, magnetT=0;
let gravityMul=1, slowFactor=1, skillReadyAt=0;

// Helpers
function ownsSkin(id){return id==='gold'||!!owned['skin.'+id];}
function updateSkinButtons(){document.querySelectorAll('.btn.skin').forEach(b=>b.classList.toggle('locked',!ownsSkin(b.dataset.skin))); }
if(!ownsSkin(skin)) skin='gold';

function applyDiff(){const d=DIFFS[diff]; speed=d.speed; gravity=d.gravity; jumpV=d.jumpV;
  document.querySelectorAll('.btn.diff').forEach(b=>b.classList.toggle('active',b.dataset.diff===diff));
  save('tapfly.diff', diff);
}
function applySkin(){ document.querySelectorAll('.btn.skin').forEach(b=>b.classList.toggle('active', b.dataset.skin===skin));
  save('tapfly.skin', skin); updateSkinButtons();
}
function updateCoinsPill(){ const el=document.getElementById('coinsPill'); if(el) el.textContent=`${CURRENCY_NAME}: ${coins}`; }
function updateClassUI(){ const b=document.getElementById('classBtn'); const c=CLASSES[classId]; if(b&&c) b.textContent='Class: '+c.name; }

function reset(){
  state.score=0; spawnMs=0; pipes.length=0; pickups.length=0; trail.length=0;
  player.x=120; player.y=(canvas.height/dpr)*0.45; player.vy=0;
  shield=0; shieldGrace=0; magnetT=0;
  gravityMul=1; slowFactor=1; skillReadyAt=0;
  applyDiff(); applySkin(); updateCoinsPill(); updateClassUI();
  CLASSES[classId]?.passiveInit?.();
}
function start(){ reset(); state.status='playing';
  if(next.shield && inv.shield>0){ shield=1; inv.shield--; saveInv(); next.shield=false; saveNext(); toast('üõ°Ô∏è Shield ON'); }
  if(next.magnet && inv.magnet>0){ magnetT=6; inv.magnet--; saveInv(); next.magnet=false; saveNext(); toast('üß≤ Magnet 6s'); }
}
function over(){ state.status='gameover';
  if(state.score>state.best){ state.best=state.score; localStorage.setItem('tapfly.best', state.best); }
  if(!daily.done && state.score>=daily.goal) completeDaily();
  if(!classUnlocked && state.score>=30){ classUnlocked=true; save('tapfly.classesUnlocked','1'); classCore+=1; save('tapfly.classCore', classCore); toast('üéì M·ªü Classes! +1 Class Core'); }
  sfxHit(); navigator.vibrate?.(60);
}
function flap(){ ensureAudio();
  if(state.status==='menu'){ start(); sfxFlap(); }
  else if(state.status==='playing'){ player.vy = jumpV; sfxFlap(); }
  else if(state.status==='paused'){ state.status='playing'; sfxTick(); }
  else if(state.status==='gameover'){ reset(); state.status='playing'; sfxFlap(); }
}

// Input
addEventListener('keydown', e=>{
  if(e.code==='Space'||e.code==='ArrowUp'){ e.preventDefault(); flap(); }
  if(e.code==='KeyR'){ reset(); state.status='playing'; }
  if(e.code==='Digit1'||e.code==='KeyE'){ diff='easy'; reset(); sfxTick(); }
  if(e.code==='Digit2'||e.code==='KeyN'){ diff='normal'; reset(); sfxTick(); }
  if(e.code==='Digit3'||e.code==='KeyH'){ diff='hard'; reset(); sfxTick(); }
  if(e.code==='KeyP'){ togglePause(); }
  if(e.code==='KeyF'||e.code==='KeyX'){ castSkill(); }
},{passive:false});
canvas.addEventListener('pointerdown', e=>{ e.preventDefault(); flap(); }, {passive:false});

document.querySelectorAll('.btn.diff').forEach(btn=> btn.addEventListener('click', ()=>{ diff=btn.dataset.diff; reset(); sfxTick(); }));
document.querySelectorAll('.btn.skin').forEach(btn=> btn.addEventListener('click', ()=>{
  const id=btn.dataset.skin; if(!ownsSkin(id)){ shopBtn?.click(); sfxTick(); return; }
  skin=id; applySkin(); sfxTick();
}));

const pauseBtn=document.getElementById('pauseBtn');
function togglePause(){ if(state.status==='playing'){ state.status='paused'; pauseBtn.textContent='‚ñ∂Ô∏è'; sfxTick(); }
  else if(state.status==='paused'){ state.status='playing'; pauseBtn.textContent='‚è∏Ô∏è'; sfxTick(); } }
pauseBtn?.addEventListener('click', togglePause);

const soundBtn=document.getElementById('soundBtn'); let muted=false;
soundBtn?.addEventListener('click', ()=>{ muted=!muted; soundBtn.textContent = muted?'üîá':'üîä'; sfxTick(); });

const classBtn=document.getElementById('classBtn'); const classesOverlay=document.getElementById('classes');
classBtn?.addEventListener('click', ()=>{ renderClasses(); classesOverlay.style.display='flex'; sfxTick(); });
document.getElementById('closeClasses')?.addEventListener('click', ()=>{ classesOverlay.style.display='none'; sfxTick(); });

// Audio
let ac=null; function ensureAudio(){ if(!ac){ const AC=window.AudioContext||window.webkitAudioContext; if(AC) ac=new AC(); }
  if(ac&&ac.state==='suspended') ac.resume();
}
function beep(freq=600,dur=0.06,vol=0.03,type='sine'){ if(muted||!ac) return;
  const o=ac.createOscillator(); const g=ac.createGain();
  o.frequency.value=freq; o.type=type; const now=ac.currentTime; g.gain.value=vol; g.gain.exponentialRampToValueAtTime(0.0001, now+dur);
  o.connect(g).connect(ac.destination); o.start(now); o.stop(now+dur);
}
const sfxFlap=()=>beep(660,.05,.03,'square');
const sfxScore=()=>beep(980,.07,.035,'triangle');
const sfxHit=()=>beep(180,.12,.045,'sawtooth');
const sfxTick=()=>beep(520,.04,.025,'sine');
const sfxCoin=()=>{ navigator.vibrate?.(12); beep(1200,.05,.035,'triangle'); };

// Voice (mic)
const voiceBtn=document.getElementById('voiceBtn');
let mic={on:false,stream:null,src:null,analyser:null,data:null,level:0,thr:0.06};
async function startVoice(){ try{
  ensureAudio(); const stream=await navigator.mediaDevices.getUserMedia({ audio:{ echoCancellation:true, noiseSuppression:true, autoGainControl:true }});
  mic.stream=stream; mic.src=ac.createMediaStreamSource(stream); mic.analyser=ac.createAnalyser(); mic.analyser.fftSize=1024; mic.data=new Float32Array(mic.analyser.fftSize);
  mic.src.connect(mic.analyser); mic.on=true; voiceBtn.textContent='üéôÔ∏è ON'; toast('Mic ON ‚Äî la ƒë·ªÉ bay');
}catch{ toast('Mic b·ªã ch·∫∑n'); } }
function stopVoice(){ mic.on=false; voiceBtn.textContent='üéôÔ∏è'; try{ mic.stream?.getTracks().forEach(t=>t.stop()); }catch{} mic.stream=mic.src=mic.analyser=mic.data=null; }
voiceBtn?.addEventListener('click', ()=>{ mic.on ? stopVoice() : startVoice(); sfxTick(); });

// Skill UI
const skillBtn=document.getElementById('skillBtn'); const cdRing=document.getElementById('cdRing');
skillBtn?.addEventListener('click', castSkill);
const skillBig = document.getElementById('skillBig');
skillBig?.addEventListener('click', castSkill);
function castSkill(){ const cls=CLASSES[classId]; if(!cls||!cls.use) return; cls.use(); }
function updateSkillUI(){
  const now=performance.now(); const left=Math.max(0, skillReadyAt - now);
  skillBtn.disabled = left>0 || state.status!=='playing';
  cdRing.style.display = left>0 ? 'grid' : 'none';
  cdRing.querySelector('span').textContent = left>0 ? (left/1000).toFixed(1) : '';
  if (skillBig){
    const disabled = (left>0 || state.status!=='playing');
    skillBig.disabled = disabled;
    skillBig.classList.toggle('disabled', disabled);
    const lbl = document.getElementById('skillBigLabel');
    lbl.textContent = left>0 ? (left/1000).toFixed(1) : '‚ö°';
  }
}

// Init
applyDiff(); applySkin(); updateCoinsPill(); updateShopGlow(); updateClassUI(); CLASSES[classId]?.passiveInit?.();
document.querySelector(`.btn.diff[data-diff="${diff}"]`)?.classList.add('active');
document.querySelector(`.btn.skin[data-skin="${skin}"]`)?.classList.add('active');
updateSkinButtons();
</script>
<script>
function targetSpawn(){ const d=DIFFS[diff]; return Math.max(d.spawnMin, d.spawnEvery - state.score*d.scoreSpawnFactor); }
function gapHeight(){ const d=DIFFS[diff]; return Math.max(d.gapMin, d.gapBase - state.score*d.scoreGapFactor) * dpr; }
function currentGapH(p){ if(!p.pulseAmp) return p.gapH; const osc=0.5+0.5*Math.sin(p.phase); return Math.max(p.gapMin, p.gapH - p.pulseAmp*osc); }

let last=performance.now();
function loop(now){
  let dt=(now-last)/1000; if(dt>0.033) dt=0.033; last=now;

  if(state.status==='playing'){
    player.vy += gravity*gravityMul*dt;
    player.y += player.vy*dt;

    if(mic.on && mic.analyser){
      mic.analyser.getFloatTimeDomainData(mic.data);
      let sum=0; for(let i=0;i<mic.data.length;i++){ const s=mic.data[i]; sum+=s*s; }
      const rms=Math.sqrt(sum/mic.data.length);
      mic.level = mic.level*0.8 + rms*0.2;
      const amp = Math.max(0, mic.level - mic.thr) / (0.4 - mic.thr);
      if(amp>0.02){ const scale = 0.6 + Math.min(1,amp)*1.1; player.vy = jumpV * scale; }
    }

    const scroll=speed*slowFactor*dt;
    for(const p of pipes){ p.x -= scroll; if(p.pulseAmp>0) p.phase += p.pulseSpd * dt; }
    for(const c of pickups){ c.x -= scroll; }
    while(pipes.length && pipes[0].x + pipes[0].w < 0) pipes.shift();
    while(pickups.length && pickups[0].x + pickups[0].r < 0) pickups.shift();

    spawnMs += dt*1000; const target = targetSpawn();
    if(spawnMs >= target){
      spawnMs=0; const gH=gapHeight();
      const margin=40*dpr; const gapY=Math.random()*(canvas.height-gH-margin*2)+margin;
      const pipe={
        x:canvas.width+20*dpr, w:80*dpr, gapY, gapH:gH,
        gapMin: DIFFS[diff].gapMin * dpr,
        pulseAmp: (Math.random()<1.3) ? Math.min(60*dpr, gH - DIFFS[diff].gapMin*dpr) : 0,
        pulseSpd: 1.2 + Math.random()*0.8, phase: 0, passed:false
      };
      pipes.push(pipe);
      if(Math.random()<0.35){ pickups.push({x:pipe.x+pipe.w+36*dpr,y:gapY+gH/2,r:10*dpr,taken:false}); }
    }

    for(const p of pipes){ if(!p.passed && p.x + p.w < player.x*dpr){
      p.passed=true; state.score++; speed=Math.min(420, speed+2); coins += 1; saveCoins(); sfxScore();
    } }

    if(shieldGrace>0) shieldGrace -= dt;
    if(magnetT>0) magnetT -= dt;

    const s=player.size*dpr, px=player.x*dpr, py=player.y*dpr;
    if(py + s > canvas.height || py < 0) over();
    for(const p of pipes){
      const inX=px + s > p.x && px < p.x + p.w;
      const gH = currentGapH(p);
      const hitTop=py < p.gapY; const hitBot=py + s > p.gapY + gH;
      if(inX && (hitTop || hitBot)){
        if(shield>0){ shield=0; shieldGrace=0.7; sfxTick(); navigator.vibrate?.(50); continue; }
        if(shieldGrace>0){ continue; }
        over(); break;
      }
    }

    for(const c of pickups){ if(!c.taken){
      const cx=c.x, cy=c.y, cr=c.r; const pcx=px+s/2, pcy=py+s/2;
      const dx=pcx-cx, dy=pcy-cy; const extra = magnetT>0 ? 140*dpr : 0;
      if(dx*dx + dy*dy <= (cr + s*0.5 + extra)*(cr + s*0.5 + extra)){ c.taken=true; coins+=5; saveCoins(); sfxCoin(); }
    } }
  }

  const W=canvas.width, H=canvas.height; ctx.clearRect(0,0,W,H);
  const pal = SKINS[skin] || SKINS.gold; const bg = ctx.createLinearGradient(0,0,0,H); bg.addColorStop(0, pal.skyTop); bg.addColorStop(1, pal.skyBot); ctx.fillStyle=bg; ctx.fillRect(0,0,W,H);
  ctx.fillStyle=pal.ground; ctx.fillRect(0,H-24*dpr,W,24*dpr);

  for(const c of pickups){ if(!c.taken){ ctx.save(); ctx.shadowColor='rgba(255,215,0,.35)'; ctx.shadowBlur=16*dpr; ctx.fillStyle='#fde047'; ctx.beginPath(); ctx.arc(c.x,c.y,c.r,0,Math.PI*2); ctx.fill(); ctx.restore(); ctx.fillStyle='rgba(0,0,0,.25)'; ctx.fillRect(c.x+c.r-4*dpr, c.y-c.r, 4*dpr, c.r*2); } }

  for(const p of pipes){
    const gH = currentGapH(p);
    ctx.fillStyle=pal.pipe;
    ctx.fillRect(p.x,0,p.w,p.gapY);
    ctx.fillRect(p.x,p.gapY+gH,p.w,H-(p.gapY+gH));
    const EDGE=4*dpr; ctx.fillStyle=pal.edge; ctx.fillRect(p.x+p.w-EDGE,0,EDGE,H);
  }

  if(trailEnabled){ for(const t of trail){ ctx.globalAlpha=t.a; ctx.fillStyle=pal.player; ctx.beginPath(); ctx.arc(t.x,t.y,6*dpr*(0.5+t.a*0.5),0,Math.PI*2); ctx.fill(); } ctx.globalAlpha=1; }

  drawSlime(ctx, player.x*dpr, player.y*dpr, player.size*dpr, pal.player);

  ctx.fillStyle='#fff'; ctx.font=(24*dpr)+'px ui-sans-serif,system-ui'; ctx.textAlign='left'; ctx.textBaseline='top';
  ctx.fillText('Score: '+state.score, 16*dpr, 12*dpr);
  ctx.fillStyle='rgba(255,255,255,.7)'; ctx.fillText('Best: '+state.best, 16*dpr, 40*dpr);
  ctx.fillStyle='#c7d2fe'; ctx.fillText('Daily: '+ Math.min(state.score, daily.goal) + '/' + daily.goal + (daily.done?' ‚úì':''), 16*dpr, 68*dpr);

  ctx.textAlign='right'; ctx.fillStyle='#fff'; ctx.fillText(CURRENCY_NAME+': '+coins, W-16*dpr, 12*dpr);
  let hudY = 40*dpr;
  if(shield>0 || shieldGrace>0){ ctx.fillText('üõ°Ô∏è', W-16*dpr, hudY); hudY += 22*dpr; }
  if(magnetT>0){ ctx.fillText('üß≤ '+magnetT.toFixed(1)+'s', W-16*dpr, hudY); }

  if(state.status!=='playing'){
    const title = state.status==='menu'?'Tap-to-Fly':(state.status==='paused'?'Paused':'Game Over');
    const subt  = state.status==='menu'?'Ch·∫°m/Space ƒë·ªÉ b·∫Øt ƒë·∫ßu':(state.status==='paused'?'Ch·∫°m/P ƒë·ªÉ ti·∫øp t·ª•c':'Ch·∫°m/Space ƒë·ªÉ ch∆°i l·∫°i');
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillStyle='rgba(0,0,0,.35)'; ctx.fillRect(W/2-220*dpr, H/2-80*dpr, 440*dpr, 160*dpr);
    ctx.fillStyle='#fff'; ctx.font=(36*dpr)+'px ui-sans-serif,system-ui'; ctx.fillText(title, W/2, H/2-18*dpr);
    ctx.font=(18*dpr)+'px ui-sans-serif,system-ui'; ctx.fillText(subt, W/2, H/2+22*dpr);
    if(state.status==='gameover' && !daily.done && state.score>=daily.goal){
      ctx.font=(16*dpr)+'px ui-sans-serif,system-ui'; ctx.fillStyle='#bbf7d0';
      ctx.fillText(`Daily ƒë·∫°t m·ª•c ti√™u! +${DAILY_REWARD}F`, W/2, H/2+52*dpr);
    }
  }

  const bar=document.getElementById('micFill'); const meter=document.getElementById('micMeter');
  if(bar){ const w = Math.max(0, Math.min(1, mic.level*2.4)); bar.style.width = (w*100).toFixed(0)+'%'; meter.style.opacity = mic.on ? '1' : '0.5'; }
  updateSkillUI();

  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

// Draw slime
function drawSlime(ctx, x, y, s, color){
  const t = Math.max(-0.35, Math.min(0.35, -player.vy/900));
  const rx = s*(0.72 + (-t)*0.30);
  const ry = s*(0.72 + ( t)*0.45);

  const grd = ctx.createRadialGradient(x-rx*0.3, y-ry*0.4, s*0.1, x, y, Math.max(rx,ry));
  grd.addColorStop(0, 'rgba(255,255,255,.35)');
  grd.addColorStop(1, color);
  ctx.save();
  ctx.shadowColor='rgba(0,0,0,.35)'; ctx.shadowBlur=16*dpr;
  ctx.beginPath(); ellipsePath(ctx, x, y, rx, ry, 10*dpr); ctx.fillStyle=grd; ctx.fill(); ctx.restore();

  ctx.fillStyle='#000'; const eyeX = x + rx*0.22; const eyeY = y - ry*0.10;
  ctx.beginPath(); ctx.arc(eyeX, eyeY, s*0.10, 0, Math.PI*2); ctx.fill();
  ctx.fillStyle='#fff'; ctx.beginPath(); ctx.arc(eyeX- s*0.03, eyeY- s*0.03, s*0.04, 0, Math.PI*2); ctx.fill();

  trail.push({x:x,y:y,a:0.75}); if(trail.length>12) trail.shift(); for(const t of trail) t.a=Math.max(0, t.a - 0.04);
}
function ellipsePath(ctx,x,y,rx,ry,r){
  r=Math.min(r,rx,ry);
  ctx.moveTo(x-rx+r, y-ry);
  ctx.arcTo(x+rx, y-ry, x+rx, y+ry, r);
  ctx.arcTo(x+rx, y+ry, x-rx, y+ry, r);
  ctx.arcTo(x-rx, y+ry, x-rx, y-ry, r);
  ctx.arcTo(x-rx, y-ry, x+rx, y-ry, r);
}
</script>
<script>
function renderClasses(){
  const info=document.getElementById('classInfo');
  info.textContent = classUnlocked ? `B·∫°n c√≥ ${classCore} Class Core. M·ªü kho√° 1 class mi·ªÖn ph√≠ ho·∫∑c d√πng Feathers.` :
                                     `C·∫ßn ƒë·∫°t ‚â•30 ·ªëng ƒë·ªÉ m·ªü m·ª•c Classes (sau khi Game Over).`;
  const list=document.getElementById('classList'); list.innerHTML='';

  for(const id of Object.keys(CLASSES)){
    const c = CLASSES[id];
    const row=document.createElement('div'); row.className='row';
    const left=document.createElement('div');
    const ownedFlag=!!classesOwned[id];
    const price = (c.price||0);
    let sub = ownedFlag?'ƒê√£ s·ªü h·ªØu':(price>0?`${CURRENCY_NAME}: ${price}`:'Mi·ªÖn ph√≠');
    left.innerHTML = `<div class="title">${c.name}</div><div class="price">${sub} ‚Ä¢ ${c.desc||''}</div>`;

    const actions=document.createElement('div'); actions.className='actions';
    const buy=document.createElement('button'); buy.className='btn';
    buy.textContent = ownedFlag?'S·ªü h·ªØu':'Mua';
    buy.disabled = ownedFlag || (!classUnlocked) || (classCore<=0 && coins<price);
    buy.addEventListener('click', ()=>{
      if(ownedFlag || !classUnlocked) return;
      if(classCore>0){ classCore--; localStorage.setItem('tapfly.classCore', classCore); }
      else { if(coins<price) return; coins-=price; saveCoins(); }
      classesOwned[id]=true; saveClasses(); renderClasses(); toast('M·ªü: '+c.name);
    });
    actions.appendChild(buy);

    const equip=document.createElement('button'); equip.className='btn';
    equip.textContent = 'Ch·ªçn';
    equip.disabled = !ownedFlag;
    equip.addEventListener('click', ()=>{ classId=id; saveClasses(); updateClassUI(); toast('Class: '+c.name); });
    actions.appendChild(equip);

    row.appendChild(left); row.appendChild(actions); list.appendChild(row);
  }
}

function toast(msg){ try{ const el=document.createElement('div'); el.textContent=msg;
  el.style.position='absolute'; el.style.right='12px'; el.style.bottom='12px';
  el.style.background='rgba(255,255,255,.12)'; el.style.border='1px solid rgba(255,255,255,.25)';
  el.style.padding='8px 10px'; el.style.borderRadius='10px'; el.style.pointerEvents='none'; el.style.zIndex='40';
  document.querySelector('.card').appendChild(el); setTimeout(()=>{ el.style.opacity='0'; el.style.transition='opacity .4s'; setTimeout(()=>el.remove(), 400); }, 900);
}catch{} }

if('serviceWorker' in navigator){ navigator.serviceWorker.register('sw.js'); }
</script>
</body>
</html>
