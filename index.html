<!doctype html>

<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tap‚Äëto‚ÄëFly ‚Äî v7 (Shield + Magnet + Neon)</title>
  <link rel="manifest" href="manifest.json">
  <style>
    :root { color-scheme: dark light; }
    html,body{margin:0;padding:0;background:#0f172a;color:#fff;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{min-height:100vh;display:grid;place-items:center;padding:16px}
    .card{width:100%;max-width:900px;aspect-ratio:16/9;border-radius:18px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.4);position:relative;border:1px solid rgba(255,255,255,.08)}
    canvas{display:block;width:100%;height:100%;background:#0f172a;touch-action:manipulation}
    .hud{position:absolute;inset:0;pointer-events:none;display:flex;align-items:flex-start;justify-content:space-between;padding:10px}
    .pill{background:rgba(255,255,255,.12);backdrop-filter:blur(8px);padding:6px 10px;border-radius:14px;font-size:12px}.toolbar{position:absolute;left:12px;bottom:44px;display:flex;gap:8px;flex-wrap:wrap;pointer-events:auto;z-index:20}
.btn{padding:6px 10px;border-radius:12px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.18);color:#fff;font-size:12px}
.btn.active{background:rgba(14,165,233,.85);border-color:rgba(255,255,255,.35)}
.btn.locked{opacity:.45;filter:grayscale(60%);border-style:dashed}
.btn.locked::after{content:" üîí";font-size:12px;opacity:.85}
.btn.skin{width:auto;display:flex;align-items:center;gap:6px}
.dot{width:12px;height:12px;border-radius:999px;border:1px solid rgba(255,255,255,.6)}
.note{position:absolute;left:12px;bottom:10px;color:#ffffffb3;font-size:12px}

/* Shop overlay */
.shop{position:absolute;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(6px);display:none;align-items:center;justify-content:center;z-index:30}
.shop .panel{width:min(600px,92%);max-height:80%;overflow:auto;background:rgba(15,23,42,.95);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:16px;box-shadow:0 20px 60px rgba(0,0,0,.5)}
.row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px dashed rgba(255,255,255,.12)}
.row:last-child{border-bottom:0}
.price{opacity:.85}
.title{font-weight:600}
.actions{display:flex;gap:8px;flex-wrap:wrap}

  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <canvas id="game"></canvas>
      <div class="hud">
        <div class="pill">Space/‚Üë ho·∫∑c ch·∫°m = bay ‚Ä¢ P = pause ‚Ä¢ üéôÔ∏è = la ƒë·ªÉ bay</div>
        <div class="pill">R = ch∆°i l·∫°i</div>
      </div><!-- Toolbar -->
  <div class="toolbar" id="toolbar">
    <button class="btn diff" data-diff="easy">Easy</button>
    <button class="btn diff" data-diff="normal">Normal</button>
    <button class="btn diff" data-diff="hard">Hard</button>
    <button class="btn" id="pauseBtn" title="T·∫°m d·ª´ng">‚è∏Ô∏è</button>
    <button class="btn" id="soundBtn" title="B·∫≠t/t·∫Øt √¢m">üîä</button>
    <button class="btn" id="voiceBtn" title="La ƒë·ªÉ bay">üéôÔ∏è</button>
    <!-- Skins (neon m·ªõi) -->
    <button class="btn skin" data-skin="gold"><span class="dot" style="background:#facc15"></span>Gold</button>
    <button class="btn skin" data-skin="pink"><span class="dot" style="background:#fb7185"></span>Pink</button>
    <button class="btn skin" data-skin="cyan"><span class="dot" style="background:#22d3ee"></span>Cyan</button>
    <button class="btn skin" data-skin="neon"><span class="dot" style="background:#a78bfa"></span>Neon</button>
    <button class="btn" id="shopBtn">Shop</button>
    <div class="btn" id="coinsPill">Feathers: 0</div>
  </div>

  <div class="note">v7: Th√™m v·∫≠t ph·∫©m **Shield** & **Magnet**, skin **Neon**, kh√≥a skin ch∆∞a mua.</div>

  <!-- Shop Overlay -->
  <div class="shop" id="shop">
    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-weight:700">Shop</div>
        <button class="btn" id="closeShop">ƒê√≥ng</button>
      </div>
      <div id="shopList"></div>
    </div>
  </div>
</div>

  </div><script>
// ===== Canvas & DPR =====
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
let dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
function fit(){
  dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
  const w = Math.min(window.innerWidth - 32, 900);
  const h = Math.floor(w * 9/16);
  canvas.style.width = w + 'px';
  canvas.style.height = h + 'px';
  canvas.width = Math.floor(w * dpr);
  canvas.height = Math.floor(h * dpr);
}
window.addEventListener('resize', fit); fit();

// ===== Skins =====
const SKINS = {
  gold:{ player:'#facc15', pipe:'#22c55e', edge:'rgba(0,0,0,.15)', skyTop:'#0ea5e9', skyBot:'#0f172a', ground:'rgba(255,255,255,.08)' },
  pink:{ player:'#fb7185', pipe:'#34d399', edge:'rgba(0,0,0,.15)', skyTop:'#ec4899', skyBot:'#312e81', ground:'rgba(255,255,255,.10)' },
  cyan:{ player:'#22d3ee', pipe:'#10b981', edge:'rgba(0,0,0,.15)', skyTop:'#06b6d4', skyBot:'#0f172a', ground:'rgba(255,255,255,.08)' },
  neon:{ player:'#a78bfa', pipe:'#22d3ee', edge:'rgba(0,0,0,.15)', skyTop:'#0ea5e9', skyBot:'#111827', ground:'rgba(255,255,255,.06)'}
};

// ===== Difficulty =====
const DIFFS = {
  easy:{ speed:180, gravity:900,  jumpV:-240, spawnEvery:1800, spawnMin:1200, gapBase:260, gapMin:200, scoreSpawnFactor:6,  scoreGapFactor:1.2 },
  normal:{speed:200, gravity:950,  jumpV:-280, spawnEvery:1700, spawnMin:1100, gapBase:220, gapMin:170, scoreSpawnFactor:8,  scoreGapFactor:1.4 },
  hard:{  speed:230, gravity:1000, jumpV:-320, spawnEvery:1600, spawnMin:1000, gapBase:190, gapMin:150, scoreSpawnFactor:10, scoreGapFactor:1.8 }
};

// ===== Currency / Ownership / Inventory =====
const CURRENCY_NAME = 'Feathers';
let coins = +(localStorage.getItem('tapfly.coins')||0);
let owned = JSON.parse(localStorage.getItem('tapfly.owned')||'{}'); // permanents (skins/trails)
let inv   = JSON.parse(localStorage.getItem('tapfly.inv')  ||'{}'); // consumables counts
let arm   = JSON.parse(localStorage.getItem('tapfly.arm')  ||'{}'); // armed consumables for next run
let diff = localStorage.getItem('tapfly.diff') || 'easy';
let skin = localStorage.getItem('tapfly.skin') || 'gold';

function invCount(id){ return inv[id]|0; }
function addInv(id,n){ inv[id] = invCount(id)+n; saveInv(); }
function useInv(id){ if(invCount(id)>0){ inv[id]-=1; saveInv(); return true; } return false; }
function saveInv(){ localStorage.setItem('tapfly.inv', JSON.stringify(inv)); }
function saveArm(){ localStorage.setItem('tapfly.arm', JSON.stringify(arm)); }
function ownsSkin(id){ return id==='gold' || !!owned['skin.'+id]; }
function updateSkinButtons(){ document.querySelectorAll('.btn.skin').forEach(b=>{ b.classList.toggle('locked', !ownsSkin(b.dataset.skin)); }); }

if(!ownsSkin(skin)) skin='gold';

// Daily bonus
const today = new Date().toDateString(); const lastDay = localStorage.getItem('tapfly.day');
if (lastDay !== today){ coins += 20; localStorage.setItem('tapfly.day', today); saveCoins(); toast('+20 daily'); }

// ===== Shop data =====
const SHOP = [
  { id:'skin.pink',  type:'skin',   label:'Skin: Pink',  price:120, apply:()=>{ skin='pink';  applySkin(); } },
  { id:'skin.cyan',  type:'skin',   label:'Skin: Cyan',  price:120, apply:()=>{ skin='cyan';  applySkin(); } },
  { id:'skin.neon',  type:'skin',   label:'Skin: Neon',  price:140, apply:()=>{ skin='neon';  applySkin(); } },
  { id:'trail.spark',type:'trail',  label:'Trail: Spark',price:120, apply:()=>{ trailEnabled = true; } },
  // Consumables (mua x1, trang b·ªã ƒë·ªÉ d√πng cho v√°n sau)
  { id:'assist.shield', type:'consum', label:'Shield x1 (ƒë·ª° 1 c√∫ ƒë·ª•ng)', price:25 },
  { id:'assist.magnet', type:'consum', label:'Magnet x1 (h√∫t coin 6s)',  price:20 },
];

function saveCoins(){ localStorage.setItem('tapfly.coins', coins); updateCoinsPill(); }
function saveOwned(){ localStorage.setItem('tapfly.owned', JSON.stringify(owned)); }

// ===== Game state =====
const state = { status:'menu', score:0, best: +(localStorage.getItem('tapfly.best')||0),
  shield:0, hitGrace:0, magnet:0 };
const player = { x:120, y:(canvas.height/dpr)*0.5, vy:0, size:20 };
const pipes = [], pickups = [], trail = [];
let trailEnabled = !!owned['trail.spark'];
let speed, gravity, jumpV, spawnMs = 0;

function applyDiff(){ const d = DIFFS[diff]; speed=d.speed; gravity=d.gravity; jumpV=d.jumpV; document.querySelectorAll('.btn.diff').forEach(b=>b.classList.toggle('active', b.dataset.diff===diff)); localStorage.setItem('tapfly.diff', diff); }
function applySkin(){ document.querySelectorAll('.btn.skin').forEach(b=>b.classList.toggle('active', b.dataset.skin===skin)); localStorage.setItem('tapfly.skin', skin); updateSkinButtons(); }
function updateCoinsPill(){ const el=document.getElementById('coinsPill'); if(el) el.textContent = `${CURRENCY_NAME}: ${coins}`; }

function reset(){
  state.score=0; state.shield=0; state.hitGrace=0; state.magnet=0; spawnMs=0;
  pipes.length=0; pickups.length=0; trail.length=0;
  player.x=120; player.y=(canvas.height/dpr)*0.45; player.vy=0;
  // ti√™u th·ª• v·∫≠t ph·∫©m ƒë√£ trang b·ªã
  if (arm['assist.shield'] && useInv('assist.shield')) { state.shield = 1; toast('üõ°Ô∏è Shield ON'); }
  if (arm['assist.magnet'] && useInv('assist.magnet')) { state.magnet = 6; toast('üß≤ Magnet 6s'); }
  applyDiff(); applySkin(); updateCoinsPill();
}
function start(){ reset(); state.status='playing'; }
function over(){ state.status='gameover'; if(state.score>state.best){ state.best=state.score; localStorage.setItem('tapfly.best', state.best); } sfxHit(); navigator.vibrate?.(60); }
function flap(){ ensureAudio(); if(state.status==='menu'){ start(); sfxFlap(); } else if(state.status==='playing'){ player.vy = jumpV; sfxFlap(); } else if(state.status==='paused'){ state.status='playing'; sfxTick(); } else if(state.status==='gameover'){ reset(); state.status='playing'; sfxFlap(); } }

// ===== Input =====
addEventListener('keydown', e=>{ if(e.code==='Space'||e.code==='ArrowUp'){ e.preventDefault(); flap(); } if(e.code==='KeyR'){ reset(); state.status='playing'; } if(e.code==='Digit1'||e.code==='KeyE'){ diff='easy'; reset(); sfxTick(); } if(e.code==='Digit2'||e.code==='KeyN'){ diff='normal'; reset(); sfxTick(); } if(e.code==='Digit3'||e.code==='KeyH'){ diff='hard'; reset(); sfxTick(); } if(e.code==='KeyP'){ togglePause(); } }, {passive:false});
canvas.addEventListener('pointerdown', e=>{ e.preventDefault(); flap(); }, {passive:false});

document.querySelectorAll('.btn.diff').forEach(btn=> btn.addEventListener('click', ()=>{ diff=btn.dataset.diff; reset(); sfxTick(); }));
document.querySelectorAll('.btn.skin').forEach(btn=> btn.addEventListener('click', ()=>{ const id=btn.dataset.skin; if(!ownsSkin(id)){ shopBtn?.click(); sfxTick(); return; } skin=id; applySkin(); sfxTick(); }));

const pauseBtn=document.getElementById('pauseBtn'); function togglePause(){ if(state.status==='playing'){ state.status='paused'; pauseBtn.textContent='‚ñ∂Ô∏è'; sfxTick(); } else if(state.status==='paused'){ state.status='playing'; pauseBtn.textContent='‚è∏Ô∏è'; sfxTick(); } } pauseBtn?.addEventListener('click', togglePause);
const soundBtn=document.getElementById('soundBtn'); let muted=false; soundBtn?.addEventListener('click', ()=>{ muted=!muted; soundBtn.textContent = muted?'üîá':'üîä'; sfxTick(); });

// ===== Shop UI =====
const shop = document.getElementById('shop'); const shopBtn = document.getElementById('shopBtn'); const closeShop = document.getElementById('closeShop');
shopBtn?.addEventListener('click', ()=>{ renderShop(); shop.style.display='flex'; sfxTick(); });
closeShop?.addEventListener('click', ()=>{ shop.style.display='none'; sfxTick(); });

function renderShop(){
  const list = document.getElementById('shopList'); list.innerHTML='';
  SHOP.forEach(item=>{
    const ownedFlag = !!owned[item.id];
    const row = document.createElement('div'); row.className='row';
    const left = document.createElement('div');
    let extra = '';
    if(item.type==='consum') extra = ` ‚Ä¢ T·ªìn kho: ${invCount(item.id)} ‚Ä¢ Trang b·ªã: ${arm[item.id]?'ON':'OFF'}`;
    left.innerHTML = `<div class="title">${item.label}</div><div class="price">${CURRENCY_NAME}: ${item.price}${extra}</div>`;

    const actions = document.createElement('div'); actions.className='actions';
    // Buy button
    const buy = document.createElement('button'); buy.className='btn';
    if(item.type==='consum'){
      buy.textContent = `Mua x1`;
      buy.disabled = coins < item.price;
      buy.addEventListener('click', ()=>{ if(coins>=item.price){ coins -= item.price; saveCoins(); addInv(item.id,1); renderShop(); sfxScore(); toast('+1 ' + item.label); }});
    } else {
      buy.textContent = ownedFlag ? 'ƒê√£ mua' : 'Mua';
      buy.disabled = ownedFlag || (coins < item.price);
      buy.addEventListener('click', ()=>{ if(coins>=item.price && !ownedFlag){ coins -= item.price; saveCoins(); owned[item.id]=true; saveOwned(); if(item.apply) item.apply(); updateSkinButtons(); renderShop(); sfxScore(); toast('ƒê√£ mua: ' + item.label); }});
    }
    actions.appendChild(buy);

    // Equip / toggle buttons
    if(item.type==='skin'){
      const equip = document.createElement('button'); equip.className='btn'; equip.textContent='Trang b·ªã'; equip.disabled = !ownedFlag; equip.addEventListener('click', ()=>{ item.apply(); saveOwned(); renderShop(); toast('Skin ƒë√£ trang b·ªã'); }); actions.appendChild(equip);
    }
    if(item.type==='trail'){
      const toggle = document.createElement('button'); toggle.className='btn'; toggle.textContent='B·∫≠t trail'; toggle.disabled = !owned['trail.spark']; toggle.addEventListener('click', ()=>{ trailEnabled = true; saveOwned(); renderShop(); toast('Trail ON'); }); actions.appendChild(toggle);
    }
    if(item.type==='consum'){
      const armBtn = document.createElement('button'); armBtn.className='btn'; armBtn.textContent = (arm[item.id]?'B·ªè trang b·ªã':'Trang b·ªã cho v√°n sau'); armBtn.disabled = invCount(item.id)<=0; armBtn.addEventListener('click', ()=>{ arm[item.id] = !arm[item.id]; saveArm(); renderShop(); }); actions.appendChild(armBtn);
    }

    row.appendChild(left); row.appendChild(actions); list.appendChild(row);
  });
  updateCoinsPill();
}

// ===== Audio =====
let ac=null; function ensureAudio(){ if(!ac){ const AC=window.AudioContext||window.webkitAudioContext; if(AC) ac=new AC(); } if(ac && ac.state==='suspended') ac.resume(); }
function beep(freq=600,dur=0.06,vol=0.03,type='sine'){ if(muted||!ac)return; const o=ac.createOscillator(); const g=ac.createGain(); o.frequency.value=freq; o.type=type; const now=ac.currentTime; g.gain.value=vol; g.gain.exponentialRampToValueAtTime(0.0001, now+dur); o.connect(g).connect(ac.destination); o.start(now); o.stop(now+dur); }
const sfxFlap=()=>beep(660,.05,.03,'square'); const sfxScore=()=>beep(980,.07,.035,'triangle'); const sfxHit=()=>beep(180,.12,.045,'sawtooth'); const sfxTick=()=>beep(520,.04,.025,'sine'); const sfxCoin=()=>beep(1200,.05,.035,'triangle');

// ===== Voice =====
const voiceBtn=document.getElementById('voiceBtn');
let mic={on:false,stream:null,src:null,analyser:null,data:null,level:0,thr:0.06};
async function startVoice(){ try{ ensureAudio(); const stream=await navigator.mediaDevices.getUserMedia({ audio:{ echoCancellation:true, noiseSuppression:true, autoGainControl:true } }); mic.stream=stream; mic.src=ac.createMediaStreamSource(stream); mic.analyser=ac.createAnalyser(); mic.analyser.fftSize=1024; mic.data=new Float32Array(mic.analyser.fftSize); mic.src.connect(mic.analyser); mic.on=true; voiceBtn.textContent='üéôÔ∏è ON'; toast('Mic ON ‚Äî la ƒë·ªÉ bay'); }catch(e){ toast('Mic b·ªã ch·∫∑n'); } }
function stopVoice(){ mic.on=false; voiceBtn.textContent='üéôÔ∏è'; try{ mic.stream?.getTracks().forEach(t=>t.stop()); }catch(_){} mic.stream=mic.src=mic.analyser=mic.data=null; }
voiceBtn?.addEventListener('click', ()=>{ mic.on ? stopVoice() : startVoice(); sfxTick(); });

// ===== Loop =====
let last=performance.now();
function loop(now){
  let dt=(now-last)/1000; if(dt>0.033) dt=0.033; last=now;
  if(state.status==='playing'){
    // physics
    player.vy += gravity*dt; player.y += player.vy*dt;

    // voice control
    if(mic.on && mic.analyser){ mic.analyser.getFloatTimeDomainData(mic.data); let sum=0; for(let i=0;i<mic.data.length;i++){ const s=mic.data[i]; sum+=s*s; } const rms=Math.sqrt(sum/mic.data.length); mic.level = mic.level*0.8 + rms*0.2; const amp = Math.max(0, mic.level - mic.thr) / (0.4 - mic.thr); if(amp>0.02){ const scale = 0.6 + Math.min(1,amp)*1.1; player.vy = jumpV * scale; } }

    // timers
    if(state.hitGrace>0) state.hitGrace -= dt;
    if(state.magnet>0)  state.magnet  -= dt;

    const scroll = speed*dt; for(const p of pipes) p.x -= scroll; for(const c of pickups) c.x -= scroll;
    while(pipes.length && pipes[0].x + pipes[0].w < 0) pipes.shift();
    while(pickups.length && pickups[0].x + pickups[0].r < 0) pickups.shift();

    // spawn
    spawnMs += dt*1000; const target = targetSpawn();
    if(spawnMs >= target){ spawnMs=0; const gapH = gapHeight(); const margin=40*dpr; const gapY = Math.random()*(canvas.height - gapH - margin*2) + margin; const pipe={ x:canvas.width + 20*dpr, w:64*dpr, gapY, gapH, passed:false }; pipes.push(pipe); if(Math.random()<0.35){ pickups.push({ x:pipe.x + pipe.w + 36*dpr, y:gapY + gapH/2, r:10*dpr, taken:false }); } }

    // score & accel
    for(const p of pipes){ if(!p.passed && p.x + p.w < player.x*dpr){ p.passed=true; state.score++; speed=Math.min(420, speed+2); coins += 1; saveCoins(); sfxScore(); } }

    // collisions
    const s = player.size*dpr; const px = player.x*dpr; const py = player.y*dpr;
    if(py + s > canvas.height || py < 0){ if(state.shield>0 && state.hitGrace<=0){ state.shield=0; state.hitGrace=0.7; sfxTick(); } else over(); }
    for(const p of pipes){ const inX = px + s > p.x && px < p.x + p.w; const hitTop = py < p.gapY; const hitBot = py + s > p.gapY + p.gapH; if(inX && (hitTop || hitBot)){ if(state.shield>0 && state.hitGrace<=0){ state.shield=0; state.hitGrace=0.7; sfxTick(); } else { over(); break; } } }

    // magnet pull
    if(state.magnet > 0){ const cx = px + s/2, cy = py + s/2; for(const c of pickups){ if(c.taken) continue; const dx=cx-c.x, dy=cy-c.y; const dist=Math.hypot(dx,dy); if(dist < 140*dpr){ c.x += (dx/dist) * (220*dt); c.y += (dy/dist) * (220*dt); } } }

    // collect coins
    for(const c of pickups){ if(!c.taken){ const cx=c.x, cy=c.y, cr=c.r; const pcx=px+s/2, pcy=py+s/2; const dx=pcx-cx, dy=pcy-cy; if(dx*dx + dy*dy <= (cr + s*0.5)*(cr + s*0.5)){ c.taken=true; coins+=5; saveCoins(); sfxCoin(); } } }

    // trail
    if(trailEnabled){ trail.push({x:px+s/2, y:py+s/2, a:1}); if(trail.length>14) trail.shift(); for(const t of trail) t.a=Math.max(0, t.a - dt*2); }
  }

  // draw
  const W=canvas.width, H=canvas.height; ctx.clearRect(0,0,W,H);
  const pal = SKINS[skin] || SKINS.gold; const grad = ctx.createLinearGradient(0,0,0,H); grad.addColorStop(0, pal.skyTop); grad.addColorStop(1, pal.skyBot); ctx.fillStyle = grad; ctx.fillRect(0,0,W,H);
  ctx.fillStyle = pal.ground; ctx.fillRect(0, H-24*dpr, W, 24*dpr);

  // pickups
  for(const c of pickups){ if(!c.taken){ ctx.save(); ctx.shadowColor='rgba(255,215,0,.35)'; ctx.shadowBlur=16*dpr; ctx.fillStyle='#fde047'; ctx.beginPath(); ctx.arc(c.x,c.y,c.r,0,Math.PI*2); ctx.fill(); ctx.restore(); ctx.fillStyle='rgba(0,0,0,.25)'; ctx.fillRect(c.x+c.r-4*dpr, c.y-c.r, 4*dpr, c.r*2); } }

  // pipes
  for(const p of pipes){ ctx.fillStyle=pal.pipe; ctx.fillRect(p.x,0,p.w,p.gapY); ctx.fillRect(p.x,p.gapY+p.gapH,p.w,H-(p.gapY+p.gapH)); ctx.fillStyle=pal.edge; ctx.fillRect(p.x+p.w-6*dpr,0,6*dpr,H); }

  // trail
  if(trailEnabled){ for(const t of trail){ ctx.globalAlpha=t.a; ctx.fillStyle=pal.player; ctx.beginPath(); ctx.arc(t.x,t.y,6*dpr*(0.5+t.a*0.5),0,Math.PI*2); ctx.fill(); } ctx.globalAlpha=1; }

  // player
  
