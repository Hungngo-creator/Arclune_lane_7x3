<!doctype html>

<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tapâ€‘toâ€‘Fly â€” v2 (Difficulty + Sound)</title>
  <link rel="manifest" href="manifest.json">
  <style>
    :root { color-scheme: dark light; }
    html,body{margin:0;padding:0;background:#0f172a;color:#fff;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{min-height:100vh;display:grid;place-items:center;padding:16px}
    .card{width:100%;max-width:900px;aspect-ratio:16/9;border-radius:18px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.4);position:relative;border:1px solid rgba(255,255,255,.08)}
    canvas{display:block;width:100%;height:100%;background:#0f172a;touch-action:manipulation}
    .hud{position:absolute;inset:0;pointer-events:none;display:flex;align-items:flex-start;justify-content:space-between;padding:10px}
    .pill{background:rgba(255,255,255,.12);backdrop-filter:blur(8px);padding:6px 10px;border-radius:14px;font-size:12px}
    .note{position:absolute;left:12px;bottom:10px;color:#ffffffb3;font-size:12px}
    /* Toolbar clickable */
    .toolbar{position:absolute;left:12px;bottom:44px;display:flex;gap:8px;flex-wrap:wrap;pointer-events:auto;z-index:20}
    .btn{padding:6px 10px;border-radius:12px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.18);color:#fff;font-size:12px}
    .btn.active{background:rgba(14,165,233,.85);border-color:rgba(255,255,255,.35)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <canvas id="game"></canvas>
      <div class="hud">
        <div class="pill">Space/â†‘ hoáº·c cháº¡m = bay</div>
        <div class="pill">R = chÆ¡i láº¡i</div>
      </div>
      <!-- Difficulty + Sound toolbar -->
      <div class="toolbar" id="toolbar">
        <button class="btn diff active" data-diff="easy">Easy</button>
        <button class="btn diff" data-diff="normal">Normal</button>
        <button class="btn diff" data-diff="hard">Hard</button>
        <button class="btn" id="soundBtn" title="Báº­t/táº¯t Ã¢m">ðŸ”Š</button>
      </div>
      <div class="note">HTML5 Canvas (1 file). CÃ³ 3 má»©c Ä‘á»™ + Ã¢m thanh.</div>
    </div>
  </div>  <script>
  // ===== Canvas + DPR resize =====
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  let dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
  function fit() {
    dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    const w = Math.min(window.innerWidth - 32, 900); // padding 16px má»—i bÃªn
    const h = Math.floor(w * 9/16);
    canvas.style.width = w + 'px';
    canvas.style.height = h + 'px';
    canvas.width = Math.floor(w * dpr);
    canvas.height = Math.floor(h * dpr);
  }
  window.addEventListener('resize', fit); fit();

  // ===== Difficulty presets =====
  const DIFFS = {
    easy:   { speed:180, gravity:900, jumpV:-240, spawnEvery:1800, spawnMin:1200, gapBase:260, gapMin:200, scoreSpawnFactor:6,  scoreGapFactor:1.2 },
    normal: { speed:200, gravity:950, jumpV:-280, spawnEvery:1700, spawnMin:1100, gapBase:220, gapMin:170, scoreSpawnFactor:8,  scoreGapFactor:1.4 },
    hard:   { speed:230, gravity:1000,jumpV:-320, spawnEvery:1600, spawnMin:1000, gapBase:190, gapMin:150, scoreSpawnFactor:10, scoreGapFactor:1.8 }
  };
  let diff = 'easy';

  // ===== Game state =====
  const state = { status: 'menu', score: 0, best: 0 };
  const player = { x: 120, y: (canvas.height/dpr)*0.5, vy: 0, size: 20 };
  const pipes = [];
  let speed = DIFFS[diff].speed;      // px/s (sáº½ set láº¡i má»—i láº§n reset)
  let gravity = DIFFS[diff].gravity;  // px/s^2
  let jumpV = DIFFS[diff].jumpV;      // px/s impulse
  let spawnMs = 0;

  function applyDiff() {
    const d = DIFFS[diff];
    speed = d.speed;
    gravity = d.gravity;
    jumpV = d.jumpV;
    // cáº­p nháº­t nÃºt active
    document.querySelectorAll('.btn.diff').forEach(b => b.classList.toggle('active', b.dataset.diff === diff));
  }

  function reset() {
    state.score = 0;
    player.x = 120;
    player.y = (canvas.height/dpr)*0.45;
    player.vy = 0;
    pipes.length = 0;
    spawnMs = 0;
    applyDiff(); // Ã¡p dá»¥ng tá»‘c Ä‘á»™/nháº£y theo Ä‘á»™ khÃ³ hiá»‡n táº¡i
  }
  function start(){ reset(); state.status='playing'; }
  function over(){ state.status='gameover'; state.best = Math.max(state.best, state.score); sfxHit(); }
  function flap(){
    ensureAudio(); // audio unlock trÃªn mobile khi cháº¡m láº§n Ä‘áº§u
    if (state.status==='menu') { start(); sfxFlap(); }
    else if (state.status==='playing') { player.vy = jumpV; sfxFlap(); }
    else if (state.status==='gameover') { reset(); state.status='playing'; sfxFlap(); }
  }

  // ===== Input =====
  document.addEventListener('keydown', (e)=>{
    if (e.code==='Space' || e.code==='ArrowUp') { e.preventDefault(); flap(); }
    if (e.code==='KeyR') { reset(); state.status='playing'; }
    if (e.code==='Digit1' || e.code==='KeyE') { diff='easy'; reset(); }
    if (e.code==='Digit2' || e.code==='KeyN') { diff='normal'; reset(); }
    if (e.code==='Digit3' || e.code==='KeyH') { diff='hard'; reset(); }
  }, {passive:false});
  canvas.addEventListener('pointerdown', (e)=>{ e.preventDefault(); flap(); }, {passive:false});

  // Toolbar buttons
  document.querySelectorAll('.btn.diff').forEach(btn => {
    btn.addEventListener('click', ()=>{ diff = btn.dataset.diff; reset(); sfxTick(); });
  });

  // Sound toggle
  const soundBtn = document.getElementById('soundBtn');
  let muted = false;
  soundBtn?.addEventListener('click', ()=>{ muted = !muted; soundBtn.textContent = muted ? 'ðŸ”‡' : 'ðŸ”Š'; sfxTick(); });

  // ===== Audio (tiny WebAudio beeps) =====
  let ac = null;
  function ensureAudio(){
    if (!ac) {
      const AC = window.AudioContext || window.webkitAudioContext;
      if (AC) ac = new AC();
    }
    if (ac && ac.state === 'suspended') ac.resume();
  }
  function beep(freq=600, dur=0.06, vol=0.03, type='sine'){
    if (muted || !ac) return;
    const o = ac.createOscillator(); const g = ac.createGain();
    o.frequency.value = freq; o.type = type;
    const now = ac.currentTime; g.gain.value = vol; g.gain.exponentialRampToValueAtTime(0.0001, now + dur);
    o.connect(g).connect(ac.destination); o.start(now); o.stop(now + dur);
  }
  const sfxFlap = ()=>beep(660, .05, .03, 'square');
  const sfxScore= ()=>beep(980, .07, .035, 'triangle');
  const sfxHit  = ()=>beep(180, .12, .045, 'sawtooth');
  const sfxTick = ()=>beep(520, .04, .025, 'sine');

  // ===== Helpers per-difficulty =====
  function targetSpawn(){
    const d = DIFFS[diff];
    const reduce = Math.min(d.spawnEvery - d.spawnMin, state.score * d.scoreSpawnFactor);
    return Math.max(d.spawnMin, d.spawnEvery - reduce);
  }
  function gapHeight(){
    const d = DIFFS[diff];
    const reduce = Math.min(d.gapBase - d.gapMin, state.score * d.scoreGapFactor);
    return Math.max(d.gapMin, d.gapBase - reduce);
  }

  // ===== Main loop =====
  let last = performance.now();
  function loop(now){
    let dt = (now - last) / 1000; if (dt>0.033) dt = 0.033; last = now;

    // Update
    if (state.status==='playing'){
      // physics
      player.vy += gravity * dt;
      player.y  += player.vy * dt;

      // pipes scroll
      const scroll = speed * dt;
      for (const p of pipes) p.x -= scroll;
      while (pipes.length && pipes[0].x + pipes[0].w < 0) pipes.shift();

      // spawn pipe pairs
      spawnMs += dt*1000;
      const target = targetSpawn();
      if (spawnMs >= target){
        spawnMs = 0;
        const gapH = gapHeight();
        const margin = 40*dpr;
        const gapY = Math.random() * (canvas.height - gapH - margin*2) + margin;
        pipes.push({ x: canvas.width + 20*dpr, w: 64*dpr, gapY, gapH, passed:false });
      }

      // scoring + accel
      for (const p of pipes){
        if (!p.passed && p.x + p.w < player.x*dpr){ p.passed = true; state.score++; speed = Math.min(420, speed+2); sfxScore(); }
      }

      // collisions
      const s = player.size * dpr; const px = player.x*dpr; const py = player.y*dpr;
      if (py + s > canvas.height || py < 0) over();
      for (const p of pipes){
        const inX = px + s > p.x && px < p.x + p.w;
        const hitTop = py < p.gapY; const hitBot = py + s > p.gapY + p.gapH;
        if (inX && (hitTop || hitBot)) { over(); break; }
      }
    }

    // Draw
    const W = canvas.width, H = canvas.height;
    ctx.clearRect(0,0,W,H);

    // sky gradient
    const g = ctx.createLinearGradient(0,0,0,H);
    g.addColorStop(0, '#0ea5e9'); g.addColorStop(1, '#0f172a');
    ctx.fillStyle = g; ctx.fillRect(0,0,W,H);

    // ground stripe
    ctx.fillStyle = 'rgba(255,255,255,.08)';
    ctx.fillRect(0, H-24*dpr, W, 24*dpr);

    // pipes
    for (const p of pipes){
      ctx.fillStyle = '#22c55e';
      ctx.fillRect(p.x, 0, p.w, p.gapY);
      ctx.fillRect(p.x, p.gapY + p.gapH, p.w, H - (p.gapY + p.gapH));
      ctx.fillStyle = 'rgba(0,0,0,.15)';
      ctx.fillRect(p.x + p.w - 6*dpr, 0, 6*dpr, H);
    }

    // player cube
    ctx.save();
    ctx.shadowColor = 'rgba(0,0,0,.35)'; ctx.shadowBlur = 16*dpr;
    ctx.fillStyle = '#facc15';
    const s = player.size*dpr, x = player.x*dpr, y = player.y*dpr;
    roundRect(ctx, x, y, s, s, 6*dpr); ctx.fill();
    ctx.restore();

    // score text
    ctx.fillStyle = '#fff';
    ctx.font = (24*dpr) + 'px ui-sans-serif,system-ui,-apple-system';
    ctx.textAlign = 'left'; ctx.textBaseline = 'top';
    ctx.fillText('Score: ' + state.score, 16*dpr, 12*dpr);
    ctx.fillStyle = 'rgba(255,255,255,.7)';
    ctx.fillText('Best: ' + state.best, 16*dpr, 40*dpr);

    // overlays
    if (state.status!=='playing'){
      const title = state.status==='menu' ? 'Tapâ€‘toâ€‘Fly' : 'Game Over';
      const subt  = state.status==='menu' ? 'Cháº¡m/Space Ä‘á»ƒ báº¯t Ä‘áº§u' : 'Cháº¡m/Space Ä‘á»ƒ chÆ¡i láº¡i';
      ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.fillStyle='rgba(0,0,0,.35)';
      ctx.fillRect(W/2 - 220*dpr, H/2 - 80*dpr, 440*dpr, 160*dpr);
      ctx.fillStyle='#fff';
      ctx.font = (36*dpr)+'px ui-sans-serif,system-ui'; ctx.fillText(title, W/2, H/2 - 18*dpr);
      ctx.font = (18*dpr)+'px ui-sans-serif,system-ui'; ctx.fillText(subt,  W/2, H/2 + 22*dpr);
    }

    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

  function roundRect(ctx,x,y,w,h,r){
    r = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+r,y);
    ctx.arcTo(x+w,y,x+w,y+h,r);
    ctx.arcTo(x+w,y+h,x,y+h,r);
    ctx.arcTo(x,y+h,x,y,r);
    ctx.arcTo(x,y,x+w,y,r);
    ctx.closePath();
  }
  </script>  <script>
    // Service worker PWA (giá»¯ nguyÃªn)
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("sw.js");
    }
  </script></body>
</html>
